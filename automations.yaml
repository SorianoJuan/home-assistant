#######################
#Alertas homeassistant
#######################

- id: homeassistant_on
  alias: Alerta de detención
  trigger:
    - platform: homeassistant
      event: start
  action:
    service: notify.mypushbullet
    data_template:
      title: "Control de hidroponia ONLINE"
      message: "Se ha iniciado el control de hidroponia"

- id: homeassistant_off
  alias: Alerta de inicio
  trigger:
    - platform: homeassistant
      event: shutdown
  action:
    service: notify.mypushbullet
    data_template:
      title: "Control de hidroponia OFFLINE"
      message: "Se ha detenido el control de hidroponia"

- id: sensor_offline
  alias: Sensor offline
  trigger:
    - platform: state
      entity_id: 
        - binary_sensor.temp_online_timeout
        - binary_sensor.hum_online_timeout
      to: "off"
  action:
    - service: notify.mypushbullet
      data_template:
        title: "Un nodo se ha desconectado"
        message: "No se han recibido actualizaciones de un nodo por más de 60 segundos"
    - service: mqtt.publish
      data:
        topic: "nodos"
        payload: "on"


###################
#HUMEDAD
###################
#INFERIOR AL MIN
- id: humedad_inf
  alias: Humedad < Min
  trigger:
    - platform: state
      entity_id: binary_sensor.hum_threshold_min
      to: 'on'
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: switch.humidificador_ambiente
        state: 'off'
      - condition: state
        entity_id: input_boolean.control_humedad
        state: "on"
  action:
    - service: notify.mypushbullet
      data_template:
        title: "La humedad ambiente descendió del mínimo establecido: {{ states.input_number.humedad_min.state }}%"
        message: "La humedad ambiente es de: {{ states.sensor.humedad_ambiente.state }}%, accionando humidificador"
    - service: mqtt.publish
      data:
        topic: "invernadero/humidificador/switch/set"
        payload: "on"
#SUPERIOR AL MAX
- id: humedad_sup
  alias: Humedad > Max
  trigger:
    - platform: state
      entity_id: binary_sensor.hum_threshold_max
      to: 'on'
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: switch.humidificador_ambiente
        state: 'on'
      - condition: state
        entity_id: input_boolean.control_humedad
        state: "on"
  action:
    - service: notify.mypushbullet
      data_template:
        title: "La humedad ambiente superó el máximo establecido: {{ states.input_number.humedad_max.state }}%"
        message: "La humedad ambiente es de: {{ states.sensor.humedad_ambiente.state }}%, deteniendo humidificador"
    - service: mqtt.publish
      data:
        topic: "invernadero/humidificador/switch/set"
        payload: "off"

- id: travis_automation
  alias: 'Update if Travis=passed'
  trigger:
    platform: state
    entity_id: sensor.sorianojuanhomeassistant_last_build_state
    to: 'passed'
  action:
    - service: script.update_config



##################
#SHOW/HIDE
##################


#Hiding automations
- id: hide_invernadero_graphs
  alias: Hide Invernadero Graphs
  trigger:
    - platform: state
      entity_id: input_boolean.show_hide_graphs
      to: "off"
  action:
    service: group.set_visibility
    entity_id: 
      - group.graficos_invernadero
    data:
      visible: False
#Showing automations
- id: show_invernadero_graphs
  alias: Show Invernadero Graphs
  trigger:
    - platform: state
      entity_id: input_boolean.show_hide_graphs
      to: "on"
  action:
    service: group.set_visibility
    entity_id: 
      - group.graficos_invernadero
    data:
      visible: True